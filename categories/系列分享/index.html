<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="">
<meta name="theme-color" content="#FFFFFF"><meta property="og:title" content="系列分享" />
<meta property="og:description" content="" />
<meta property="og:type" content="website" />
<meta property="og:url" content="http://example.org/categories/%E7%B3%BB%E5%88%97%E5%88%86%E4%BA%AB/" />
<meta property="og:updated_time" content="2015-05-23T23:41:37+00:00" />
<title>系列分享 | IT小课</title>
<link rel="manifest" href="/manifest.json">
<link rel="icon" href="/favicon.png" type="image/x-icon">
<link rel="stylesheet" href="/book.min.6df681b0bb21155cba49f6078e3559216772d8e03e780d240c73ea21817ed5e5.css" integrity="sha256-bfaBsLshFVy6SfYHjjVZIWdy2OA&#43;eA0kDHPqIYF&#43;1eU="><link rel="alternate" type="application/rss+xml" href="http://example.org/categories/%E7%B3%BB%E5%88%97%E5%88%86%E4%BA%AB/index.xml" title="IT小课" />
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->

  <style>
    .book-brand img {
        width: 150px;
        height: 60px;
        margin-top: -20px;
    }
</style>
</head>

<body>
  <input type="checkbox" class="hidden" id="menu-control" />
  <main class="container flex">
    <aside class="book-menu">
      
<nav>
  <h2 class="book-brand">
  <a href="/"><img src="http://blogcdn.idoustudio.com/learnitwell.png" alt="Logo" />
  </a>
</h2>
  


  
  




  
  




  

  
  
</nav>




<script>
  {
    {
      . | safeJS
    }
  }
</script>


      
    </aside>

    <div class="book-page">
      <header class="book-header">
        
<div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>系列分享</strong>

  <label for="toc-control">
    <img src="/svg/toc.svg" class="book-icon" alt="Table of Contents" />
  </label>
</div>



<input type="checkbox" class="hidden" id="toc-control" />
<aside class="hidden clearfix">
  
  <nav>
  <ul>
  
    
    <li class="book-section-flat">
      <strong>Categories</strong>
      <ul>
      
        <li class="flex justify-between">
          <a href="/categories/%E7%B3%BB%E5%88%97%E5%88%86%E4%BA%AB/">系列分享</a>
          <span>7</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/categories/development/">Development</a>
          <span>2</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/categories/golang/">golang</a>
          <span>2</span>
        </li>
      
      </ul>
    </li>
    
  
    
    <li class="book-section-flat">
      <strong>Tags</strong>
      <ul>
      
        <li class="flex justify-between">
          <a href="/tags/weiphp/">weiphp</a>
          <span>7</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/weiphp%E6%8F%92%E4%BB%B6%E5%BC%80%E5%8F%91/">weiphp插件开发</a>
          <span>6</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/%E7%BD%91%E9%A1%B5%E9%87%87%E9%9B%86%E6%8A%80%E6%9C%AF/">网页采集技术</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/weiphp%E6%8F%92%E4%BB%B6%E5%BC%80%E5%8F%91%E6%95%99%E7%A8%8B/">weiphp插件开发教程</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/%E6%88%90%E8%AF%AD%E6%8E%A5%E9%BE%99/">成语接龙</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/development/">development</a>
          <span>2</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/go/">go</a>
          <span>2</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/golang/">golang</a>
          <span>2</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/hugo/">hugo</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/templates/">templates</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/themes/">themes</a>
          <span>1</span>
        </li>
      
      </ul>
    </li>
    
  
  </ul>
</nav>


</aside>


        
      </header>

      
<style>
    .header {
        height: 60px;
        font-size: 36px;
        font-weight: 600;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        border-bottom: 1px solid #ccc;
        margin-bottom: 30px;
    }

    .book-toc nav {
        margin-top: 60px;
    }
</style>
<div class="header">
    Categories
</div>

      
  
  <article class="markdown book-post">
    <h2>
      <a href="/courses/weiphp-dev/vol1/">第一个自定义weiphp插件：MyHello</a>
    </h2>
    
  <h5>January 5, 2015</h5>



  
  <div>
    
      <a href="/categories/%E7%B3%BB%E5%88%97%E5%88%86%E4%BA%AB/">系列分享</a>
  </div>
  

  
  <div>
    
      <a href="/tags/weiphp/">weiphp</a>, 
      <a href="/tags/weiphp%E6%8F%92%E4%BB%B6%E5%BC%80%E5%8F%91/">weiphp插件开发</a>
  </div>
  


    <p>我们都知道，学习任何一门编程语言，一般来说第一个范例程序就是输出“Hello World”。从今天开始我们来学习 weiphp 插件开发，也从一个 HelloWorld 级别的插件开始讲起，因为安装好了的 weiphp 框架，默认安装了 weiphp 官方开发的 HelloWorld 插件，所以这里为了防止跟官方的插件冲突，我们开发的第一个自定义 weiphp 插件取名为 MyHello，并通过这个简单的插件来讲解 weiphp 插件开发的整个流程。整个【分分钟上手 weiphp 插件开发】系列教程都是直接从创建一个新的插件开始讲起的，逐步延生到插件编码、微信响应、数据模型设计等内容，并假定阅读本教程的用户都具有一定的 php 编程基础且已成功搭建好了 weiphp 开发框架，关于如何在服务器上部署 weiphp、weiphp 框架代码结构、weiphp 数据模型等知识请自行参考其他的教程。本系列教程基于的 weiphp 框架版本为 2.0.1202，依赖的服务器为阿里云。
下面开始讲解第一个自定义 weiphp 插件：MyHello 的开发流程。
1、插件创建。在 weiphp 管理后台依次点击“插件管理-&gt;创建插件”进入插件创建页面，填写插件的标识名、插件名、版本、作者、描述等信息，勾选“安装后是否启用”、“是否需要配置”两项，点击“确定”完成插件的创建。
2、插件安装。在插件管理列表中点击“安装”完成插件的安装。
3、插件管理。返回到 weiphp 管理前台，可以看到 MyHello 插件已经成功安装。
4、改写配置文件。在 weiphp 的 addons 目录下默认生成的 MyHello 插件文件夹下面改写默认生成的 config.php，添加如下图所示配置项。
5、查看配置项。可以看到配置文件已经正常响应。
6、微信响应。为 WeixinAddonModel.class.php 中编写微信响应代码。
7、编辑配置项。在后台配置页面填写配置信息，上传封面图片，并点“确定”提交配置项。
8、微信测试。在微信中回复“我的插件”或者“MyHello”时，根据配置项中选择的回复类型是“文本消息”还是“单图文消息”来进行回复。
    </p>
  </article>
  
  <article class="markdown book-post">
    <h2>
      <a href="/courses/weiphp-dev/vol2/">成语接龙插件：Idioms</a>
    </h2>
    
  <h5>January 9, 2015</h5>



  
  <div>
    
      <a href="/categories/%E7%B3%BB%E5%88%97%E5%88%86%E4%BA%AB/">系列分享</a>
  </div>
  

  
  <div>
    
      <a href="/tags/weiphp/">weiphp</a>, 
      <a href="/tags/weiphp%E6%8F%92%E4%BB%B6%E5%BC%80%E5%8F%91%E6%95%99%E7%A8%8B/">weiphp插件开发教程</a>, 
      <a href="/tags/%E6%88%90%E8%AF%AD%E6%8E%A5%E9%BE%99/">成语接龙</a>
  </div>
  


    <p>上个月的某一天逛开源中国社区，无意间看到一个帖子：http://www.oschina.net/code/snippet_2286076_44811，发帖的人分享了一个成语接龙的 API，当时觉得挺好玩的，就拿来做了一个 weiphp 成语接龙插件。做这样的一个插件还是很简单的，没有数据模型，不需要管理后台，也不需要写控制器和视图层的代码，直接在微信交互模型中根据用户的发送内容调用 API 返回内容就行了，开发过程中用到了一个很 nice 的 weiphp 方法：set_user_status()。下面把这个 weiphp 成语接龙插件的开发流程分享出来，让各位看官对 weiphp 插件开发能有更深一层次的理解。学会了这个插件，那么对于 weiphp 官方提供的智能聊天、机器人学习时间这样的插件源代码就不难理解了，如果想自己开发天气查询、四六级查询、火车查询等功能就会得心应手了。无非就是编辑微信交互模型，根据用户输入调用相应的 API 嘛~
废话不多说，走起~
1、创建插件。在 weiphp 管理后台创建成语接龙插件，勾选安装后立即启用，不需要配置项和管理列表。点“确定”完成插件的创建。
2、安装插件。
3、检测插件是否成功安装。返回到 weiphp 插件管理后台，可以看到成语接龙插件已经成功安装，因为创建该插件的时候没有勾选需要配置项，所以此处没有显示插件配置页面。
4、编写微信响应代码。
首先，我们来调试一下成语接龙的接口
由调试结果我们可以发现，要使用户正常完成成语接龙，必须重复多次获得用户的输入关键词，当用户输入“成语接龙”时开始触发本插件，提示用户输入一个成语，然后获取用户的下一次输入，把用户的下一次输入提交到成语接龙接口地址，用 file_get_contents()函数获得接口返回的内容，如果接口返回内容是一个成语的话，则继续获取用户的下一次输入，并把用户输入的关键词提交到接口，按此规律循环，多次获取用户的输入关键词；若接口返回的内容是不是一个成语，比如是“成语必须为 4 个汉字”之类的提示语时，则回复给用户的消息中提示用户重新输入一个成语或者输入“退出”退出成语接龙；当用户输入的关键词为“退出”时，则退出成语接龙插件，用户的下一次输入将不会提交到成语接龙接口。
整个微信交互模型开发的思路我们弄清楚了，接下来就开始写代码，其中最关键的是用到 weiphp 封装的一个函数 set_user_status(),这个函数的位置及用法如下图所示
这个函数的大概意思就是把用户的输入作为缓存存储起来，与用户的下一次输入进行关联，从而完成一次连贯输入操作。用法比较简单，传递的第一个参数为插件的标识名，传递的第二个参数为自定义的一个关键词。
下面我们就用这个函数来写一下连贯输入操作：
5、微信测试。
    </p>
  </article>
  
  <article class="markdown book-post">
    <h2>
      <a href="/courses/weiphp-dev/vol3/">留言板插件：Liuyanban</a>
    </h2>
    
  <h5>January 10, 2015</h5>



  
  <div>
    
      <a href="/categories/%E7%B3%BB%E5%88%97%E5%88%86%E4%BA%AB/">系列分享</a>
  </div>
  

  
  <div>
    
      <a href="/tags/weiphp/">weiphp</a>, 
      <a href="/tags/weiphp%E6%8F%92%E4%BB%B6%E5%BC%80%E5%8F%91/">weiphp插件开发</a>
  </div>
  


    <p>现在市面上有很多形如《xxx 实战教程》、《xxx 案例开发大全》之类的开发书籍，关于书的内容质量怎么样我就不多说了，呵呵一句你们就会懂的。我个人还是比较喜欢国外的编程教学类书籍，书中讲解的内容大部分都是比较严谨的，不仅讲实战，也会把原理解释得很清楚。但是国内的教程能做到这样的就很少了。回到正题上来，我们这次讲解的是 weiphp 留言板插件的开发流程，大家都知道，留言板是一门 web 开发技术入门级的案例，学习任何一门 web 开发技术，不管是 java、php 还是 python、ruby 之类的，要是能够写出一个留言板的实例来，那么就可以证明你算是入门了。所以我们今天就开始通过一个留言板的实例来入门 weiphp 插件开发。
在开发此插件前，我们先来看一下这个插件的效果图，这里给大家分享一个我用 bootstrap 写的比较简单的留言板界面，一共两个页面：留言列表页面和发布留言页面，大家可以在我的百度云上面下载这个前台模板：http://pan.baidu.com/s/1sjFgsVF
留言列表页面
发布留言页面
看到前台效果图，我们大概知道这个插件做好之后是怎么样了，这个插件相对来说比较简单，需要用到 weiphp 插件模板、数据模型等。
下面我们开始一步一步来完成这个插件：
1、创建插件。在 weiphp 管理后台中创建留言板插件，把下面的安装后是否立即启用、是否需要配置、是否需要管理列表全部勾上（如果需要进行数据库操作，并且插件用到的数据库只有一个表时就勾上需要管理列表，这时候在插件管理后台就会出现数据管理列表，列表里面的内容默认会调用与插件标识名一致的数据模型进行显示，也就是说如果我们把是否需要管理列表这个选项勾上了，那么我们在创建数据模型的时候需要把数据模型命名为 Liuyanban，这样的话我们就不需要对数据模型显示的方法进行重载即可调用 weiphp 默认的方法进行数据显示与管理，如果我们的模型名与插件标识名不一致的话，那么我们需要改写数据管理控制器，这个后面会讲到。）
2、安装插件。
3、查看插件是否安装成功。在插件管理后台可以看到留言板插件已经成功安装了，因为勾选了需要配置和需要管理列表，所以这个地方能看到配置页面和数据管理页面，因为数据模型和数据列表还没有定义，所以数据管理页面并没有显示每个字段标题。
4、创建数据模型。在 weiphp 管理后台依次点击“系统-&gt;模型管理-&gt;新增”，进入数据模型创建页面，并创建 Liuyanban 数据模型。
5、创建字段。在模型列表里面找到上一步创建好的 Liuyanban 数据模型，并点字段管理进入字段管理页面。
点击新增依次建立如下字段。
6、定义数据列表。在模型列表页面再次找到 liuyanban 模型，点击编辑进入模型编辑页面；
在模型编辑页面点击设计进入列表定义页面；
按下图所示进行列表定义。
7、查看数据列表。再次回到插件管理后台，可以看到列表定义的字段已经显示出来。
8、编辑配置文件。改写 config.php，添加下图所示配置项。
回到插件管理后台，可以看到配置项成功应用。
上传一张封面图片并点“确定”提交配置项。
9、编写微信交互模型。在微信模型中设置当用户输入“留言板”触发此插件时回复单图文消息，跳转到留言列表页面（Liuyanban 控制器下的 index 方法），并传递用户的 openid 和公众号的 token 两个参数。其中 get_token()、get_openid()、addons_url()、get_cover_url()为 weiphp 封装的较为常用的方法，可以在 Application/Common/Common/function.php 中查看这些方法对应的用法和功能。
10、显示前台模板。在 Liuyanban 控制器中新建 index()和 liuyan()两个方法，分别用于显示留言列表页面和发布留言页面。
下载前台模板文件http://pan.baidu.com/s/1sjFgsVF，并把文件粘贴至 Liuyanban 插件的模板文件夹下面。
        <a href="/courses/weiphp-dev/vol3/">...</a>
      
    </p>
  </article>
  
  <article class="markdown book-post">
    <h2>
      <a href="/courses/weiphp-dev/vol4/">签到插件：QianDao</a>
    </h2>
    
  <h5>April 12, 2015</h5>



  
  <div>
    
      <a href="/categories/%E7%B3%BB%E5%88%97%E5%88%86%E4%BA%AB/">系列分享</a>
  </div>
  

  
  <div>
    
      <a href="/tags/weiphp/">weiphp</a>, 
      <a href="/tags/weiphp%E6%8F%92%E4%BB%B6%E5%BC%80%E5%8F%91/">weiphp插件开发</a>
  </div>
  


    <p>相信看过《分分钟上手 weiphp 插件开发》系列教程 前三篇的朋友对 weiphp 插件开发应该不陌生了，那么今天就再来分享一个相对较为简单的小功能的开发过程：weiphp 签到插件开发详解。
其实签到功能在提高公众号用户粘性方面起到了很大的作用，通常会在一些电商类的平台中使用，运营人员通过设置相应的奖励来提高用户的签到积极性。鉴于时间有限，今天我要分享的这个签到功能较为简单，功能比较单一，感兴趣的朋友可以在此基础上继续扩展，完成更高级的功能，以达到商用的目标。
1、首先肯定是在 weiphp 超级管理后台创建这个插件。不需要配置，需要管理列表。
2、然后是安装这个插件。
3、创建一个名为 qiandao 的数据模型，并新建四个字段。
4、编辑 qiandao 数据模型的列表定义。
5、编辑微信交互模型。weiphp/Addons/QianDao/Model/WeixinAddonModel.class.php
代码解析：红框里面的就是整个签到功能的微信交互代码。首先获取到发送”签到“的用户的 openid 和当前公众号的 token，以及发送消息的时间和日期；然后判断一下该用户对应的 openid、token 以及日期 date 是否存在于签到表中（签到表中的不能存在 openid、token、date 完全相同的两条记录，即同一用户不能在同一天重复签到），如果用户已经签到过了，则提示用户不能重复签到。如果用户在发送消息的这一天是第一次签到，则把用户的 openid、当前公众号的 token、发送消息这天的日期 date 以及发送消息的时间 ctime 都存入到 qiandao 表，然后统计出签到表中日期 date 与用户发送消息当天的 date 相同的记录总数，提示用户是第几个签到的。
6、在插件管理页面就能看到用户的签到记录。
7、在微信端预览效果。
至此，签到功能开发完毕，有兴趣的朋友可以在此基础上扩展这个功能，比如管理员可以在后台设置签到规则和签到的奖品之类的，授人以鱼不如授人以渔，希望大家多多思考，能够掌握 weiphp 插件开发的精髓。
    </p>
  </article>
  
  <article class="markdown book-post">
    <h2>
      <a href="/courses/weiphp-dev/vol5/">网页采集技术在weiphp插件中的使用</a>
    </h2>
    
  <h5>April 12, 2015</h5>



  
  <div>
    
      <a href="/categories/%E7%B3%BB%E5%88%97%E5%88%86%E4%BA%AB/">系列分享</a>
  </div>
  

  
  <div>
    
      <a href="/tags/weiphp/">weiphp</a>, 
      <a href="/tags/weiphp%E6%8F%92%E4%BB%B6%E5%BC%80%E5%8F%91/">weiphp插件开发</a>, 
      <a href="/tags/%E7%BD%91%E9%A1%B5%E9%87%87%E9%9B%86%E6%8A%80%E6%9C%AF/">网页采集技术</a>
  </div>
  


    <p>自从写了一系列开发教程之后，每天都有很多的朋友来问我问题，有时候手机上网特别不方便回答，于是想到了做一个技术问答社区，来专门解决微信开发爱好者在开发中遇到的各种问题，于是有了艾豆问答社区。
我对于艾豆问答社区的定位是做一个专注于微信开发问答的技术交流社区，类似于知乎、SegmentFault 这种的，现在的规划是分成 weiphp、微擎、小猪 CMS 几个板块，添加微信插件开发、微信功能定制等话题，通过技术分享、源码分享等方式来吸引各个平台的微信开发用户，以定制开发作为主要营收模式。
艾豆问答社区采用开源的问答社区程序 WeCenter 二次开发而成，由于技术、运营都只有我一个人，艾豆问答社区发展的进度比较慢，这几天想到了把我在艾豆问答社区解决的一些问题分享到艾豆乐园微信公众号里面，让所有的公众号用户能够浏览和提问，起到一个移动化交流的作用。于是想到了数据采集。
背景交代完毕，现在开始正题，讲一下如何用 curl 技术抓取目标网页并把抓取内容在微信中展示。
先来看一下要抓取的网站：http://idouly.com/wenda/
我现在需要做的就是把那些问问题的帖子都抓取下来，然后放到微信中显示。
关于创建插件、安装插件等等内容我就不写了，看过《分分钟上手 weiphp 插件开发》系列教程前面四篇的朋友应该都清楚。我现在主要讲一下这个插件的微信交互部分。
先贴代码：
从第 17-53 行是整个功能的核心代码。第 17-20 行是最基本的 curl 网页抓取程序，首先做的是把http://idouly.com/wenda/这个网站上所有的内容抓下来。第 22 行是一条正则匹配规则，匹配出所有的问题，并把匹配到的内容存在数组$m 中。第 24-29 行是构建多图文消息的第一条消息。第 31-35 行是定义五张小图片。第 37-44 行构建了一个 for 循环，取出匹配到的问题数组中的最新五个问题，并用问题标题、链接以及自定义的小图片构建 5 条单图文消息。第 46-51 行构建最后一条单图文消息，点击该条消息可跳转至艾豆问答社区首页。第 53 行回复一条多图文消息（共 7 条单图文）。
看一下微信端的效果：
可以看到，但用户发送关键词触发此插件后，微信交互模型会自动去艾豆问答社区采集最新的五个问题，并把采集到的问题构建至一条多图文消息发送给用户。至此，整个功能开发完毕。
此插件开发起来比较简单，关键是需要熟练使用 curl 技术，设计合理的正则表达式匹配出所需的内容。对网页采集感兴趣的朋友可以去看一下我的其他的采集教程：http://idoubi.cc/?p=280，也可以联系我购买我的”掌上头条“微信采集插件。其中”掌上头条“微信采集插件非常有技术含量，里面运用了很多高级的正则匹配技术、模拟采集技术，具有很大的借鉴意义。
    </p>
  </article>
  
  <article class="markdown book-post">
    <h2>
      <a href="/courses/weiphp-dev/vol6/">微信高级客服接口在weiphp插件中的使用</a>
    </h2>
    
  <h5>April 20, 2015</h5>



  
  <div>
    
      <a href="/categories/%E7%B3%BB%E5%88%97%E5%88%86%E4%BA%AB/">系列分享</a>
  </div>
  

  
  <div>
    
      <a href="/tags/weiphp/">weiphp</a>, 
      <a href="/tags/weiphp%E6%8F%92%E4%BB%B6%E5%BC%80%E5%8F%91/">weiphp插件开发</a>
  </div>
  


    <p>接到一个用户的需求：想更改一下 weiphp 通用表单插件，当用户在微信端填写表单内容并提交表单后，系统自动把该用户填写的内容发送给指定的用户。
评估了一下这个需求，发现做起来其实还是很容易的，主要就是需要用到微信的高级接口：客服接口。具体思路是：创建自定义通用表单时填写一个需要把表单内容发往的微信用户 uid（该 uid 可通过在微信中回复“uid”查看）——&gt;当用户提交表单成功之后调用微信的高级接口把表单的内容发给指定用户。
下面我们开始更改 weiphp 自带的通用表单（Forms）插件：
1、在智能聊天（Chat）的微信交互模型（/Addons/Chat/Model/WeixinAddonModel.class.php）中实现当用户发送“uid”时返回用户 uid 的功能。
2、在 weiphp 后台模型管理中找到 forms 模型，新增一个字段 uid。
3、在微信中查看 uid。
4、在通用表单插件中新建一个表单，并把表单提交后需要通知的用户 uid 填上去。
5、新建几个字段。
6、在 Application/Common/Common/function.php 中新增几个方法，用于使用微信客服接口（客服接口只有认证了的服务号才能使用）。
7、在通用表单的控制器中改写表单提交的方法，当表单提交成功后调用客服接口函数给后台指定的用户发消息。
8、我们现在在微信发送“报名”来触发第 4 步中创建的表单。
9、点击进入填写表单。
10、填写好表单之后点“确定”提交表单，被指定的用户在微信中就会立刻接到通知。
好啦，本次任务圆满完成，客户承诺给的 500 元报酬妥妥的就到手了。
weiphp 的通用表单还是很强大的，可以实现很多功能，而微信高级接口的接入自然让此功能如虎添翼。客服接口属于微信认证服务号独有的接口，有了此接口可以实现很多高级的功能，比如订餐系统中用户提交订单后店主接到订单通知、微信运营者与微信用户实时互动之类的。更多实用、好玩的功能还要靠大家一起去探索，本文只起到抛钻引玉的作用~
    </p>
  </article>
  
  <article class="markdown book-post">
    <h2>
      <a href="/courses/weiphp-dev/vol7/">模拟请求技术在weiphp插件中的应用</a>
    </h2>
    
  <h5>May 23, 2015</h5>



  
  <div>
    
      <a href="/categories/%E7%B3%BB%E5%88%97%E5%88%86%E4%BA%AB/">系列分享</a>
  </div>
  

  
  <div>
    
      <a href="/tags/weiphp/">weiphp</a>, 
      <a href="/tags/weiphp%E6%8F%92%E4%BB%B6%E5%BC%80%E5%8F%91/">weiphp插件开发</a>
  </div>
  


    <p>博主对于 curl 网页采集技术可谓是研究颇深，上个学期用 curl 技术写的一个名为“高校头条”的新闻采集系统前段时间刚刚卖出去了，同样用 curl 技术写的一个微信文章采集的 weiphp 插件“掌上头条”自发布以来已经卖出去几十个了，衷心感谢各位朋友对博主的支持，也让博主有了更高的热情在网页采集与数据挖掘这一领域更进一步的走下去。
关于 curl 采集技术在 weiphp 插件中的实际运用我前面已经写过好多篇文章了，今天要给大家讲的是模拟请求技术，说白了也是 curl 的一种形式，就是在自己的代码中往目标网址模拟发送数据包，从而获得所需要的内容。很多人做过的刷票、论坛批量发帖基本上都是类似的原理。
在 weiphp 系统中，有一个自带的插件叫“智能聊天”。在插件配置界面有一个填写图灵机器人 key 的文本框，用户需要在图灵机器人官网申请到一个正确的 key 值并填入此框，才能使用图灵机器人智能聊天的功能。
但是呢，经常有朋友反馈说图灵机器人莫名其妙的就失效了。似乎通过申请图灵机器人 key 来使用智能聊天功能并不是一个很好的解决方案。于是博主便去图灵机器人官网的产品体验区体验了一发。
体验的感觉还是不错的，图灵机器人的回复还算比较智能。于是博主便想到了在 weiphp 插件中模拟产品体验中与图灵机器人聊天的这个过程。当用户在微信端发送关键词后，把用户的关键词模拟提交到图灵机器人的智能回复处理地址，获得图灵机器人的回复内容，然后再把内容发送给用户。整个思路还是很清晰。下来就来讲一下流程。
1、先来抓个包看一下，不需要安装 fiddler、firebug 之类的高级抓包工具，用 chrome 浏览器的 F12 调试面板就可以了。
2、通过抓包我们可以清晰的看到当用户发送“你吃饭没有”时，数据请求的地址是：http://www.tuling123.com/openapi/productexp.do，请求方式是：POST，带的cookie是：JSESSIONID=aaa4rSE2Lk_HZ-XBWkb2u;（后面那个cookie是cnzz的cookie，没有多大用），发送的数据是：你吃饭没有。
3、再来看一下接收到的数据。可以看到接收的是 xml 格式的数据，标签里的“刚吃了”就是我们需要的数据。
4、整个与图灵机器人聊天的过程中数据包传输的过程我们已经弄清楚了，只需要写一段代码来模拟这个过程就可以获得我们所需要的数据了。那么现在还需要搞清楚的一个问题就是：聊天过程中发送的 cookie 是怎么来的。分析之后我们可以发现，模拟聊天过程中并没有要求我们登陆，也就是说这个 cookie 不是在用户登陆之后才得到的，而是访问这个聊天页面时自动生成的。所以我们只需要在模拟聊天之前访问这个页面，获得相应的 cookie，然后再带着这个 cookie 去模拟发送数据到处理聊天的地址，就可以获得图灵机器人的回复内容了。
5、整个思路搞清楚了，下面上代码。我们更改一下 weiphp 自带的智能聊天插件 Chat，把模拟图灵机器人聊天的代码加上，让每次用户在微信端输入内容后，把用户输入的内容模拟发送到图灵机器人的聊天处理地址，然后通过正则表达式匹配出图灵机器人回复的内容，再把匹配出的内容回复给用户，整个微信端智能聊天过程就这么搞定了。直接上代码，看不懂的请百度 curl 教程。
6、代码写完之后只要在微信端发送内容，系统就会自动的把用户发送的内容 post 到图灵机器人的聊天处理地址，然后把匹配出来的内容回复给用户。妥妥的整个数据模拟请求的过程就实现了。不过由于整个数据模拟请求过程中涉及到跨域请求，内容回复可能会有一点点的延迟~
由于博主时间、精力有些，一些细节过程就没有详细写出来了，但凡有点 php 基础的朋友对整个过程理解起来应该不是很费劲。
    </p>
  </article>
  

  



      
      

      <footer class="book-footer">
        
<div class="flex flex-wrap justify-between">





</div>


        
        
      </footer>

      


      

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      
  <nav>
  <ul>
  
    
    <li class="book-section-flat">
      <strong>Categories</strong>
      <ul>
      
        <li class="flex justify-between">
          <a href="/categories/%E7%B3%BB%E5%88%97%E5%88%86%E4%BA%AB/">系列分享</a>
          <span>7</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/categories/development/">Development</a>
          <span>2</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/categories/golang/">golang</a>
          <span>2</span>
        </li>
      
      </ul>
    </li>
    
  
    
    <li class="book-section-flat">
      <strong>Tags</strong>
      <ul>
      
        <li class="flex justify-between">
          <a href="/tags/weiphp/">weiphp</a>
          <span>7</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/weiphp%E6%8F%92%E4%BB%B6%E5%BC%80%E5%8F%91/">weiphp插件开发</a>
          <span>6</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/%E7%BD%91%E9%A1%B5%E9%87%87%E9%9B%86%E6%8A%80%E6%9C%AF/">网页采集技术</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/weiphp%E6%8F%92%E4%BB%B6%E5%BC%80%E5%8F%91%E6%95%99%E7%A8%8B/">weiphp插件开发教程</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/%E6%88%90%E8%AF%AD%E6%8E%A5%E9%BE%99/">成语接龙</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/development/">development</a>
          <span>2</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/go/">go</a>
          <span>2</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/golang/">golang</a>
          <span>2</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/hugo/">hugo</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/templates/">templates</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/themes/">themes</a>
          <span>1</span>
        </li>
      
      </ul>
    </li>
    
  
  </ul>
</nav>


      
    </aside>
    
  </main>

  
</body>

</html>











